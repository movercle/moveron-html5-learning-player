<!doctype html>
<!--
  Copyright 2025 POC HTML5 Content Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POC Player (iframe wrapper)</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; background:#0b0c10; color:#fff; }
    .top { padding: 12px 16px; display:flex; justify-content:space-between; align-items:center; background:#111; border-bottom:1px solid #222; }
    .panel { display:flex; gap: 12px; align-items:center; }
    .chip { font-size:12px; color:#bbb; }
    .wrap { display:grid; grid-template-columns: 1fr 420px; gap: 12px; padding: 12px; }
    iframe { width:100%; height: calc(100vh - 120px); border:0; border-radius: 12px; background:#fff; }
    .log { height: calc(100vh - 120px); border-radius: 12px; background:#111; border:1px solid #222; overflow:auto; padding: 10px; font-size: 12px; }
    .row { border-bottom:1px dashed #2a2a2a; padding: 8px 0; }
    .k { color:#8ab4ff; }
    .btn { padding: 8px 10px; border:1px solid #333; background:#111; color:#fff; border-radius: 10px; cursor:pointer; transition: all 0.2s; }
    .btn:hover { background:#222; border-color:#555; }
    .nav-bar { padding: 12px 16px; background:#0d0e12; border-bottom:1px solid #222; display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .nav-bar label { font-size: 13px; color: #999; margin-right: 8px; }
    .content-btn { padding: 8px 16px; border:1px solid #333; background:#1a1b1f; color:#fff; border-radius: 8px; cursor:pointer; font-size: 13px; transition: all 0.2s; }
    .content-btn:hover { background:#2a2b2f; border-color:#555; }
    .content-btn.active { background:#667eea; border-color:#667eea; font-weight: bold; }
  </style>
</head>
<body>
  <div class="top">
    <div class="panel">
      <b>POC Player</b>
      <span class="chip" id="sid">session: -</span>
    </div>
    <div class="panel">
      <button class="btn" id="btnClear">ë¡œê·¸ì§€ìš°ê¸°</button>
    </div>
  </div>

  <div class="nav-bar">
    <label>ğŸ“š ìƒ˜í”Œ ì½˜í…ì¸ :</label>
    <button class="content-btn" data-src="../content/index.html">ê¸°ë³¸ ì½˜í…ì¸ </button>
    <button class="content-btn" data-src="../moveron_html5_sample/index.html">MoverOn ìƒ˜í”Œ</button>
    <button class="content-btn active" data-src="../poc-mp4-html5/index.html">POC MP4</button>
    <button class="content-btn" data-src="../poc-youtube-html5/index.html">POC YouTube</button>
    <button class="content-btn" data-src="../poc-pdf-html5/index.html">POC pdf</button>
  </div>

  <div class="wrap">
    <!-- content/index.html ì„ ë¡œë”©í•˜ì„¸ìš” -->
    <iframe id="frame" src="../poc-mp4-html5/index.html"></iframe>

    <div class="log" id="log"></div>
  </div>

  <script>
    const CHANNEL = "MOVERON_POC";
    const frame = document.getElementById("frame");
    const logEl = document.getElementById("log");

    const sessionId = "S-" + Math.random().toString(16).slice(2);
    document.getElementById("sid").textContent = "session: " + sessionId;

    // POCìš© Resume ì €ì¥ì†Œ(ì‹¤ì œë¡œëŠ” DB/Redis ë“±ì— ì €ì¥)
    const resumeStore = {
      location: null,
      state: null
    };

    function addLog(line, obj) {
      const div = document.createElement("div");
      div.className = "row";
      div.innerHTML = `<div><span class="k">${line}</span></div><pre style="white-space:pre-wrap;margin:6px 0 0;color:#ccc;">${obj ? escapeHtml(JSON.stringify(obj, null, 2)) : ""}</pre>`;
      logEl.prepend(div);
    }
    function escapeHtml(s){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // ìì²´ API ëª©ì—…(POC): ì‹¤ì œ êµ¬í˜„ ì‹œ fetchë¡œ êµì²´
    async function trackingApi(type, payload) {
      // ì˜ˆ) await fetch("/api/learning/events", {method:"POST", headers:{...}, body: JSON.stringify(...)})
      addLog("API -> " + type, payload);
      return { ok: true };
    }

    // ì½˜í…ì¸ ë¡œ ë©”ì‹œì§€ ë³´ë‚´ê¸°
    function postToContent(type, payload) {
      frame.contentWindow?.postMessage({ channel: CHANNEL, type, payload }, "*");
    }

    window.addEventListener("message", async (e) => {
      const msg = e.data;
      if (!msg || msg.channel !== CHANNEL) return;

      if (msg.type === "READY") {
        addLog("CONTENT READY", msg);
        postToContent("SESSION", { sessionId });

        // ì´ˆê¸° ìë™ Resume ì œê³µ(ì›í•˜ë©´ ì£¼ì„ í•´ì œ)
        // postToContent("RESUME_DATA", { location: resumeStore.location, state: resumeStore.state });
        return;
      }

      // ì½˜í…ì¸  â†’ í”Œë ˆì´ì–´ ì´ë²¤íŠ¸
      if (msg.type === "EVENT") {
        await trackingApi("EVENT", { sessionId, meta: msg.meta, ...msg.payload, ts: msg.ts });
        return;
      }
      if (msg.type === "LOCATION") {
        resumeStore.location = msg.payload.location;
        await trackingApi("LOCATION", { sessionId, meta: msg.meta, ...msg.payload, ts: msg.ts });
        return;
      }
      if (msg.type === "STATE") {
        resumeStore.state = msg.payload.state;
        await trackingApi("STATE", { sessionId, meta: msg.meta, ...msg.payload, ts: msg.ts });
        return;
      }
      if (msg.type === "SUSPEND") {
        resumeStore.location = msg.payload.location;
        resumeStore.state = msg.payload.state;
        await trackingApi("SUSPEND", { sessionId, meta: msg.meta, ...msg.payload, ts: msg.ts });
        return;
      }
      if (msg.type === "RESUME_REQUEST") {
        addLog("RESUME_REQUEST", { location: resumeStore.location, hasState: !!resumeStore.state });
        postToContent("RESUME_DATA", { location: resumeStore.location, state: resumeStore.state });
        return;
      }
      if (msg.type === "COMPLETE") {
        await trackingApi("COMPLETE", { sessionId, meta: msg.meta, ...msg.payload, ts: msg.ts });
        return;
      }
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      logEl.innerHTML = "";
    });

    // ì½˜í…ì¸  ë„¤ë¹„ê²Œì´ì…˜ ê¸°ëŠ¥
    const contentButtons = document.querySelectorAll(".content-btn");

    contentButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const newSrc = btn.getAttribute("data-src");

        // í™œì„± ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
        contentButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        // iframe ì†ŒìŠ¤ ë³€ê²½
        frame.src = newSrc;

        // ë¡œê·¸ ì´ˆê¸°í™”
        logEl.innerHTML = "";

        // Resume ì €ì¥ì†Œ ì´ˆê¸°í™”
        resumeStore.location = null;
        resumeStore.state = null;

        addLog("ì½˜í…ì¸  ë³€ê²½ë¨", { src: newSrc });
      });
    });
  </script>
</body>
</html>
